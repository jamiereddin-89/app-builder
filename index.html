
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Made on Vibes DIY</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
    <script>
      // Suppress Babel transformer warning for development
      window.BABEL_PRESET_SUPPRESS_WARNING = true;
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <script src="https://unpkg.com/react-window/umd/react-window.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }
      #container {
        width: 100%;
        height: 100vh;
      }
      
      /* Toast animations */
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
      
      /* Monaco Editor Styles */
      #monaco-editor {
        width: 100% !important;
        height: 100% !important;
      }
      
      .monaco-editor {
        border-radius: 0 !important;
      }
    </style>
  </head>
  <body>
    <div id="container"></div>
    <script>
      window.CALLAI_API_KEY = "";
      window.CALLAI_CHAT_URL = "https://vibes-diy-api.com/";
      window.CALLAI_IMG_URL = "https://vibes-diy-api.com/";
    </script>
    <script type="importmap">
      {
  "imports": {
    "react": "https://esm.sh/react",
    "react-dom": "https://esm.sh/react-dom",
    "react-dom/client": "https://esm.sh/react-dom/client",
    "react/jsx-runtime": "https://esm.sh/react/jsx-runtime",
    "use-fireproof": "https://esm.sh/use-vibes@0.18.9",
    "call-ai": "https://esm.sh/call-ai@0.18.9",
    "use-vibes": "https://esm.sh/use-vibes@0.18.9",
    "diff": "https://esm.sh/diff@5.2.0",
    "https://esm.sh/use-fireproof": "https://esm.sh/use-vibes@0.18.9",
    "https://esm.sh/use-vibes": "https://esm.sh/use-vibes@0.18.9"
  }
}
    </script>
    <script type="text/babel" data-type="module">
      import ReactDOMClient from "react-dom/client";

      // prettier-ignore
      import React, { useState, useEffect, useRef, useDeferredValue } from "react";
import { useFireproof } from "use-fireproof";

// Import extracted components
// import { ToastContainer } from './components/Toast.js'; // Inlined below
import { AppList, AppCard } from './components/AppList.js';
import { AppBuilder } from './components/AppBuilder.js';
import { AppPreview } from './components/AppPreview.js';
import { AppDetails } from './components/AppDetails.js';
import { TemplateModal } from './components/TemplateModal.js';
import { ShareModal } from './components/ShareModal.js';
import { VersionHistoryModal } from './components/VersionHistoryModal.js';
import { ExportModal } from './components/ExportModal.js';
import { KeyboardShortcutsModal } from './components/KeyboardShortcutsModal.js';
import { ChatPanel } from './components/ChatPanel.js';
import ErrorBoundary from './components/ErrorBoundary.js';

// Inlined Toast Component to avoid module loading issues with Babel
function Toast({ toast, onRemove }) {
  const isSuccess = toast.type === "success";
  const isError = toast.type === "error";
  
  const toastStyles = isSuccess 
    ? "bg-green-500 text-white shadow-[inset_2px_2px_4px_#16a34a,inset_-2px_-2px_4px_#22c55e]"
    : isError 
    ? "bg-red-500 text-white shadow-[inset_2px_2px_4px_#dc2626,inset_-2px_-2px_4px_#ef4444]"
    : "bg-[#e8e8e8] shadow-[inset_4px_4px_8px_#c5c5c5,inset_-4px_-4px_8px_#ffffff]";
  
  const icon = isSuccess ? "‚úÖ" : isError ? "‚ùå" : "‚ÑπÔ∏è";
  
  return (
    <div className={`${toastStyles} rounded-2xl p-4 mb-3 flex items-center gap-3 transform transition-all duration-300 ease-in-out animate-in slide-in-from-right-full`}
      style={{
        animation: 'slideIn 0.3s ease-out forwards'
      }}
    >
      <span className="text-xl">{icon}</span>
      <span className="flex-1 font-medium">{toast.message}</span>
      <button 
        onClick={() => onRemove(toast.id)}
        className="text-white hover:text-gray-200 transition-colors text-xl leading-none"
      >
        √ó
      </button>
    </div>
  );
}

function ToastContainer({ toasts, removeToast }) {
  if (toasts.length === 0) return null;
  
  return (
    <div className="fixed top-4 right-4 z-50 max-w-sm w-full space-y-2">
      {toasts.map(toast => (
        <Toast 
          key={toast.id} 
          toast={toast} 
          onRemove={removeToast} 
        />
      ))}
    </div>
  );
}

// Import custom hooks
import { useAppManagement } from './hooks/useAppManagement.js';
import { usePuterSDK } from './hooks/usePuterSDK.js';
import { useModels } from './hooks/useModels.js';

export default function App() {
  // Initialize custom hooks
  const appManagement = useAppManagement();
  const puterSDK = usePuterSDK();
  const modelsHook = useModels();
  
  // Initialize SDK and toast functions
  useEffect(() => {
    puterSDK.initToast(showToast);
    modelsHook.initToast(showToast);
    appManagement.initToast(showToast);
    puterSDK.initPuterSDK();
  }, []);
  
  // State from hooks
  const { apps, versions, generating, generationStage } = appManagement;
  const { puter, user } = puterSDK;
  const { models } = modelsHook;
  
  // Local state
  const [prompt, setPrompt] = useState("");
  const [appName, setAppName] = useState("");
  const [appTitle, setAppTitle] = useState("");
  const [selectedApp, setSelectedApp] = useState(null);
  const [editCode, setEditCode] = useState("");
  const [model, setModel] = useState("gpt-4o-mini");
  const [provider, setProvider] = useState("All");
  const [log, setLog] = useState([]);
  const [showCode, setShowCode] = useState(false);
  const [tags, setTags] = useState([]);
  const [tagInput, setTagInput] = useState("");
  const [selectedTags, setSelectedTags] = useState([]);
  
  // New feature states
  const [searchQuery, setSearchQuery] = useState("");
  const deferredSearchQuery = useDeferredValue(searchQuery);
  const [selectedTemplate, setSelectedTemplate] = useState(null);
  const [showTemplates, setShowTemplates] = useState(false);
  const [showVersions, setShowVersions] = useState(false);
  const [selectedApps, setSelectedApps] = useState(new Set());
  const [bulkMode, setBulkMode] = useState(false);
  const [sortBy, setSortBy] = useState("date");
  const [filterFavorites, setFilterFavorites] = useState(false);
  const [showAnalytics, setShowAnalytics] = useState(false);
  const [showExportModal, setShowExportModal] = useState(false);
  const [showShareModal, setShowShareModal] = useState(false);
  const [shareLink, setShareLink] = useState("");
  const [qrCodeDataURL, setQRCodeDataURL] = useState("");
  const [isGeneratingQR, setIsGeneratingQR] = useState(false);
  const [activeTab, setActiveTab] = useState("build");
  const [darkMode, setDarkMode] = useState(() => {
    try {
      const saved = localStorage.getItem('darkMode');
      return saved ? JSON.parse(saved) : false;
    } catch (error) {
      console.warn('localStorage not available, using default dark mode setting');
      return false;
    }
  });
  const [activeCategory, setActiveCategory] = useState("All");
  const fileInputRef = useRef(null);
  
  // Preview zoom state - safely access localStorage only from parent window
  const [previewZoom, setPreviewZoom] = useState(() => {
    try {
      if (selectedApp && window.parent === window) {
        const saved = localStorage.getItem(`previewZoom_${selectedApp._id}`);
        return saved ? parseFloat(saved) : 1.0;
      }
      return 1.0;
    } catch (error) {
      console.warn('localStorage not available, using default zoom');
      return 1.0;
    }
  });
  
  // Monaco Editor ref and initialization state
  const monacoEditorRef = useRef(null);
  const [monacoInitialized, setMonacoInitialized] = useState(false);
  const [monacoLoading, setMonacoLoading] = useState(false);
  const [monacoError, setMonacoError] = useState(null);
  
  // Toast state management
  const [toasts, setToasts] = useState([]);
  
  // Help modal state
  const [showHelpModal, setShowHelpModal] = useState(false);
  
  // Version diff state
  const [selectedOldVersion, setSelectedOldVersion] = useState(null);
  const [selectedNewVersion, setSelectedNewVersion] = useState(null);
  const [diffViewMode, setDiffViewMode] = useState('unified');

  // AI Chat state
  const [chatHistory, setChatHistory] = useState([]);
  const [chatInput, setChatInput] = useState("");
  const [isChatVisible, setIsChatVisible] = useState(false);
  const [isChatLoading, setIsChatLoading] = useState(false);
  const [suggestions, setSuggestions] = useState([]);

  // Templates
  const templates = [
    { id: "todo", name: "Todo App", icon: "‚úÖ", prompt: "A beautiful todo app with categories, priorities, due dates, dark/light mode toggle, and local storage persistence", category: "Productivity" },
    { id: "calculator", name: "Calculator", icon: "üî¢", prompt: "A scientific calculator with history, memory functions, keyboard support, and a sleek modern UI", category: "Utilities" },
    { id: "notes", name: "Notes App", icon: "üìù", prompt: "A notes app with markdown support, folders, search, tags, and auto-save functionality", category: "Productivity" },
    { id: "timer", name: "Pomodoro Timer", icon: "‚è±Ô∏è", prompt: "A pomodoro timer with customizable work/break intervals, statistics, sounds, and notifications", category: "Productivity" },
    { id: "weather", name: "Weather Dashboard", icon: "üå§Ô∏è", prompt: "A weather dashboard that shows current conditions, 5-day forecast, with beautiful animations and location search", category: "Utilities" },
    { id: "kanban", name: "Kanban Board", icon: "üìã", prompt: "A kanban board with drag-and-drop cards, multiple columns, labels, and local storage", category: "Productivity" },
    { id: "password", name: "Password Generator", icon: "üîê", prompt: "A password generator with strength meter, customizable options, copy to clipboard, and password history", category: "Utilities" },
    { id: "quiz", name: "Quiz Game", icon: "üéØ", prompt: "An interactive quiz game with multiple categories, scoring, timer, and leaderboard", category: "Entertainment" },
    { id: "expense", name: "Expense Tracker", icon: "üí∞", prompt: "An expense tracker with categories, charts, monthly budgets, and export functionality", category: "Productivity" },
    { id: "drawing", name: "Drawing App", icon: "üé®", prompt: "A drawing canvas with brush sizes, colors, shapes, layers, undo/redo, and save as image", category: "Entertainment" },
    { id: "music", name: "Music Player", icon: "üéµ", prompt: "A music player UI with playlist, progress bar, volume control, shuffle, and visualizer", category: "Entertainment" },
    { id: "chat", name: "Chat Interface", icon: "üí¨", prompt: "A chat interface with message bubbles, typing indicators, timestamps, and emoji picker", category: "Communication" },
  ];

  const addLog = (msg) => setLog(prev => [...prev.slice(-16), `${new Date().toLocaleTimeString()}: ${msg}`]);
  const displayCode = editCode || selectedApp?.code || "";

  // Chat history persistence functions
  const saveChatHistory = (appId, history) => {
    try {
      localStorage.setItem(`chatHistory_${appId}`, JSON.stringify(history));
    } catch (error) {
      console.warn('Failed to save chat history:', error);
    }
  };

  const loadChatHistory = (appId) => {
    try {
      const saved = localStorage.getItem(`chatHistory_${appId}`);
      return saved ? JSON.parse(saved) : [];
    } catch (error) {
      console.warn('Failed to load chat history:', error);
      return [];
    }
  };

  // Load chat history when selected app changes
  useEffect(() => {
    if (selectedApp?._id) {
      const history = loadChatHistory(selectedApp._id);
      setChatHistory(history);
    } else {
      setChatHistory([]);
    }
  }, [selectedApp?._id]);

  // Save chat history when it changes
  useEffect(() => {
    if (selectedApp?._id && chatHistory.length > 0) {
      saveChatHistory(selectedApp._id, chatHistory);
    }
  }, [chatHistory, selectedApp?._id]);

  // AI Chat function for iterative edits
  const iterateOnApp = async (message) => {
    if (!selectedApp || !puter || !message.trim()) return;
    
    setIsChatLoading(true);
    
    try {
      // Add user message to history
      const userMessage = { role: "user", content: message, timestamp: Date.now() };
      setChatHistory(prev => [...prev, userMessage]);
      setChatInput("");
      
      addLog("Processing AI chat request...");
      
      // Prepare system prompt for code iteration
      const systemPrompt = `You are an expert web developer helping improve an existing app.
You are given:
1. Current app code
2. User feedback/suggestions
3. Previous conversation context

Your task:
- Analyze the current code
- Provide specific, actionable suggestions
- If suggesting code changes, format them clearly with explanations
- Maintain the app's existing functionality and design
- Return ONLY your analysis and suggestions, no meta-commentary`;
      
      // Build conversation context
      const conversationContext = chatHistory.map(msg => ({
        role: msg.role,
        content: msg.content
      }));
      
      // Add current code and user message
      const currentCode = selectedApp.code || editCode || "";
      const messages = [
        { role: "system", content: systemPrompt },
        { role: "user", content: `Current app code:\n\`\`\`html\n${currentCode}\n\`\`\`\n\nUser feedback: ${message}` },
        ...conversationContext
      ];
      
      const res = await puter.ai.chat(messages, { model });
      
      let aiResponse = res?.message?.content || res?.text || res?.content || String(res);
      aiResponse = aiResponse.trim();
      
      // Parse suggestions from AI response
      const parsedSuggestions = parseSuggestions(aiResponse);
      
      // Add AI response to history
      const aiMessage = { 
        role: "assistant", 
        content: aiResponse, 
        suggestions: parsedSuggestions,
        timestamp: Date.now() 
      };
      setChatHistory(prev => [...prev, aiMessage]);
      setSuggestions(parsedSuggestions);
      
      addLog("AI response received");
      
    } catch (err) {
      addLog(`Chat error: ${err.message}`);
      showToast(`Chat error: ${err.message}`, "error");
    }
    setIsChatLoading(false);
  };
  
  // Parse suggestions from AI response
  const parseSuggestions = (response) => {
    const suggestions = [];
    
    // Look for code blocks with explanations
    const codeBlockRegex = /```(?:html|javascript|css)?\s*([\s\S]*?)```/g;
    let match;
    
    while ((match = codeBlockRegex.exec(response)) !== null) {
      const code = match[1].trim();
      const beforeCode = response.substring(0, match.index).trim();
      const afterCode = response.substring(match.index + match[0].length).trim();
      
      // Try to find explanation for this code block
      let explanation = beforeCode;
      if (afterCode && !explanation) {
        explanation = afterCode;
      }
      
      if (code && explanation) {
        suggestions.push({
          code,
          explanation: explanation.replace(/^[^.!?]*[.!?]\s*/, '').trim() || "Suggested improvement"
        });
      }
    }
    
    // If no code blocks found, look for specific suggestions
    if (suggestions.length === 0) {
      const suggestionLines = response.split('\n')
        .filter(line => line.toLowerCase().includes('suggest') || 
                       line.toLowerCase().includes('improve') ||
                       line.toLowerCase().includes('change') ||
                       line.toLowerCase().includes('update'));
      
      suggestionLines.forEach(line => {
        if (line.trim().length > 10) {
          suggestions.push({
            code: null,
            explanation: line.trim()
          });
        }
      });
    }
    
    return suggestions;
  };
  
  // Apply suggestion to code
  const applySuggestion = (suggestion) => {
    if (!selectedApp || !suggestion.code) return;
    
    try {
      const currentCode = editCode || selectedApp.code || "";
      
      // Simple approach: replace the entire code with the suggestion
      // In a more sophisticated implementation, you'd want diff/patch logic
      setEditCode(suggestion.code);
      
      // Mark suggestion as applied
      setSuggestions(prev => prev.map(s => 
        s === suggestion ? { ...s, applied: true } : s
      ));
      
      showToast("Suggestion applied to code!", "success");
      addLog("Applied AI suggestion");
      
    } catch (err) {
      showToast(`Failed to apply suggestion: ${err.message}`, "error");
    }
  };
  
  // Toast management functions
  const showToast = (message, type = "success", duration = 3000) => {
    const id = Date.now() + Math.random();
    const newToast = { id, message, type };
    
    setToasts(prev => [...prev, newToast]);
    
    // Auto-dismiss after duration
    setTimeout(() => {
      setToasts(prev => prev.filter(toast => toast.id !== id));
    }, duration);
    
    return id;
  };
  
  const removeToast = (id) => {
    setToasts(prev => prev.filter(toast => toast.id !== id));
  };

  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyDown = (e) => {
      // Don't trigger shortcuts when typing in inputs or textareas
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.contentEditable === 'true') {
        return;
      }

      const isCtrlOrCmd = e.ctrlKey || e.metaKey;

      switch (e.key.toLowerCase()) {
        case 'k':
          if (isCtrlOrCmd) {
            e.preventDefault();
            // Focus search input if on apps tab, otherwise switch to apps tab first
            if (activeTab !== 'apps') {
              setActiveTab('apps');
              // Small delay to ensure tab switch completes before focusing
              setTimeout(() => {
                const searchInput = document.querySelector('input[placeholder="Search apps..."]');
                if (searchInput) searchInput.focus();
              }, 100);
            } else {
              const searchInput = document.querySelector('input[placeholder="Search apps..."]');
              if (searchInput) searchInput.focus();
            }
          }
          break;

        case 'b':
          if (isCtrlOrCmd) {
            e.preventDefault();
            setActiveTab('build');
          }
          break;

        case 's':
          if (isCtrlOrCmd) {
            e.preventDefault();
            // Save/redeploy if editing
            if (selectedApp && editCode && !generating) {
              handleUpdateAndRedeploy();
            }
          }
          break;

        case 'escape':
          e.preventDefault();
          // Close any open modals
          const modals = [
            showExportModal, showShareModal, showVersions, 
            showTemplates, showHelpModal
          ];
          if (showExportModal) setShowExportModal(false);
          if (showShareModal) setShowShareModal(false);
          if (showVersions) setShowVersions(false);
          if (showTemplates) setShowTemplates(false);
          if (showHelpModal) setShowHelpModal(false);
          break;

        case '?':
          if (isCtrlOrCmd) {
            e.preventDefault();
            setShowHelpModal(true);
          }
          break;
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [activeTab, selectedApp, editCode, generating, showExportModal, showShareModal, showVersions, showTemplates, showHelpModal]);

  // Tag management functions
  const addTag = () => {
    const trimmedTag = tagInput.trim();
    if (trimmedTag && !tags.includes(trimmedTag)) {
      setTags([...tags, trimmedTag]);
      setTagInput("");
    }
  };

  const removeTag = (tagToRemove) => {
    setTags(tags.filter(tag => tag !== tagToRemove));
  };

  const toggleTagFilter = (tag) => {
    setSelectedTags(prev =>
      prev.includes(tag) ? prev.filter(t => t !== tag) : [...prev, tag]
    );
  };

  // Get all unique tags from apps
  const getAllTags = () => {
    const allTags = apps.flatMap(app => app.tags || []);
    return [...new Set(allTags)].sort();
  };

  // Get unique categories from templates
  const getCategories = () => {
    const categories = [...new Set(templates.map(t => t.category))];
    return ["All", ...categories.sort()];
  };

  // Filter templates by active category
  const filteredTemplates = activeCategory === "All"
    ? templates
    : templates.filter(t => t.category === activeCategory);

  // Filter and sort apps
  const filteredApps = apps
    .filter(app => {
      if (filterFavorites && !app.favorite) return false;
      if (deferredSearchQuery) {
        const q = deferredSearchQuery.toLowerCase();
        return (
          app.appName?.toLowerCase().includes(q) ||
          app.appTitle?.toLowerCase().includes(q) ||
          app.prompt?.toLowerCase().includes(q)
        );
      }
      if (selectedTags.length > 0) {
        const appTags = app.tags || [];
        return selectedTags.some(tag => appTags.includes(tag));
      }
      return true;
    })
    .sort((a, b) => {
      if (sortBy === "date") return (b.createdAt || 0) - (a.createdAt || 0);
      if (sortBy === "name") return (a.appTitle || a.appName || "").localeCompare(b.appTitle || b.appName || "");
      if (sortBy === "views") return (b.views || 0) - (a.views || 0);
      return 0;
    });

  // App analytics
  const analytics = {
    totalApps: apps.length,
    totalVersions: versions.filter(v => selectedApp && v.appId === selectedApp._id).length,
    favorites: apps.filter(a => a.favorite).length,
    totalViews: apps.reduce((sum, a) => sum + (a.views || 0), 0),
    modelsUsed: [...new Set(apps.map(a => a.model))].length,
    avgCodeSize: apps.length ? Math.round(apps.reduce((sum, a) => sum + (a.code?.length || 0), 0) / apps.length) : 0
  };



   useEffect(() => {
     try {
       localStorage.setItem('darkMode', JSON.stringify(darkMode));
     } catch (error) {
       console.warn('Failed to save dark mode setting to localStorage:', error);
     }
   }, [darkMode]);
   
   // Preview zoom effects - safe localStorage access
   useEffect(() => {
     try {
       if (selectedApp && window.parent === window) {
         localStorage.setItem(`previewZoom_${selectedApp._id}`, previewZoom.toString());
       }
     } catch (error) {
       console.warn('Failed to save zoom level to localStorage:', error);
     }
   }, [previewZoom, selectedApp]);
   
   // Keyboard shortcuts for zoom
   useEffect(() => {
     const handleKeyDown = (e) => {
       if (e.ctrlKey || e.metaKey) {
         switch (e.key) {
           case '=':
           case '+':
             e.preventDefault();
             zoomIn();
             break;
           case '-':
             e.preventDefault();
             zoomOut();
             break;
           case '0':
             e.preventDefault();
             resetZoom();
             break;
         }
       }
     };
     
     window.addEventListener('keydown', handleKeyDown);
     return () => window.removeEventListener('keydown', handleKeyDown);
   }, [previewZoom, selectedApp]);
   
   // Zoom control functions
   const zoomIn = () => {
     setPreviewZoom(prev => Math.min(prev + 0.1, 3.0));
   };
   
   const zoomOut = () => {
     setPreviewZoom(prev => Math.max(prev - 0.1, 0.25));
   };
   
   const resetZoom = () => {
     setPreviewZoom(1.0);
   };

  // Duplicate app function using hook
  const handleDuplicateApp = async (appToDuplicate, e) => {
    e?.stopPropagation();
    try {
      await appManagement.duplicateApp({ appToDuplicate, puter, user });
    } catch (error) {
      addLog(`Duplication failed: ${error.message}`);
    }
  };
   
   // Monaco Editor initialization with proper error handling
   useEffect(() => {
     let editorInstance = null;
     let isMounted = true;
     
     const initializeMonaco = () => {
       if (!showCode || !displayCode || !monacoEditorRef.current || 
           !monacoEditorRef.current.parentNode || !isMounted) {
         setMonacoLoading(false);
         return;
       }
       
       setMonacoLoading(true);
       setMonacoError(null);
       
       try {
         // Load Monaco Editor
         require.config({ 
           paths: { 
             'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' 
           } 
         });
         
         require(['vs/editor/editor.main'], function () {
           if (!isMounted || !monacoEditorRef.current || !monacoEditorRef.current.parentNode) {
             setMonacoLoading(false);
             return;
           }
           
           try {
             // Create Monaco Editor
             editorInstance = monaco.editor.create(monacoEditorRef.current, {
               value: editCode || selectedApp?.code || '',
               language: 'html',
               theme: darkMode ? 'vs-dark' : 'vs-light',
               fontSize: 14,
               tabSize: 2,
               lineNumbers: 'on',
               minimap: { enabled: false },
               wordWrap: 'on',
               automaticLayout: true,
               scrollBeyondLastLine: false,
               folding: true,
               autoIndent: 'advanced',
               formatOnPaste: true,
               formatOnType: true,
             });
             
             // Mark as initialized
             if (isMounted) {
               setMonacoInitialized(true);
               setMonacoLoading(false);
             }
             
             // Update content when code changes
             const updateContent = () => {
               if (!editorInstance || !isMounted) return;
               
               try {
                 const currentContent = editorInstance.getValue();
                 const newContent = editCode || selectedApp?.code || '';
                 if (currentContent !== newContent) {
                   editorInstance.setValue(newContent);
                 }
               } catch (error) {
                 console.warn('Failed to update editor content:', error);
               }
             };
             
             // Update editor when props change
             if (editCode || selectedApp?.code) {
               updateContent();
             }
             
             // Listen for changes and update state
             const disposables = editorInstance.onDidChangeModelContent(() => {
               if (!isMounted) return;
               
               try {
                 setEditCode(editorInstance.getValue());
               } catch (error) {
                 console.warn('Failed to get editor value:', error);
               }
             });
             
             // Store editor instance
             monacoEditorRef.current = editorInstance;
             
             // Cleanup function
             return () => {
               isMounted = false;
               setMonacoInitialized(false);
               setMonacoLoading(false);
               if (editorInstance) {
                 try {
                   editorInstance.dispose();
                 } catch (error) {
                   console.warn('Failed to dispose editor:', error);
                 }
               }
               if (disposables) {
                 try {
                   disposables.dispose();
                 } catch (error) {
                   console.warn('Failed to dispose disposables:', error);
                 }
               }
             };
           } catch (error) {
             console.error('Failed to create Monaco editor:', error);
             setMonacoError(error.message);
             setMonacoLoading(false);
             showToast('Failed to initialize code editor', 'error');
           }
         });
       } catch (error) {
         console.error('Failed to load Monaco editor:', error);
         setMonacoError(error.message);
         setMonacoLoading(false);
         showToast('Failed to load code editor', 'error');
       }
     };
     
     // Small delay to ensure DOM is ready
     const timeoutId = setTimeout(initializeMonaco, 200);
     
     return () => {
       isMounted = false;
       clearTimeout(timeoutId);
       setMonacoLoading(false);
       if (editorInstance) {
         try {
           editorInstance.dispose();
         } catch (error) {
           console.warn('Failed to dispose editor on cleanup:', error);
         }
       }
     };
   }, [showCode, displayCode]);
   
   // Update Monaco Editor theme when darkMode changes
   useEffect(() => {
     try {
       if (monacoEditorRef.current && monacoInitialized && typeof monaco !== 'undefined') {
         monaco.editor.setTheme(darkMode ? 'vs-dark' : 'vs-light');
       }
     } catch (error) {
       console.warn('Failed to update Monaco editor theme:', error);
     }
   }, [darkMode, monacoInitialized]);
   
   // Update Monaco Editor content when editCode or selectedApp changes
   useEffect(() => {
     try {
       if (monacoEditorRef.current && showCode && monacoInitialized && 
           typeof monacoEditorRef.current.getValue === 'function') {
         const currentContent = monacoEditorRef.current.getValue();
         const newContent = editCode || selectedApp?.code || '';
         if (currentContent !== newContent) {
           monacoEditorRef.current.setValue(newContent);
         }
       }
     } catch (error) {
       console.warn('Failed to update Monaco editor content:', error);
     }
   }, [editCode, selectedApp, showCode, monacoInitialized]);

  // Use hook methods for providers and filtering
  const providers = modelsHook.getProviders();
  const filtered = modelsHook.getFilteredModels(provider);

  // Build and deploy function using hook
  const handleBuildAndDeploy = async (customPrompt) => {
    const finalPrompt = customPrompt || prompt;
    try {
      const newApp = await appManagement.buildAndDeploy({
        prompt: finalPrompt,
        appName,
        appTitle,
        model,
        tags,
        puter,
        user
      });
      if (newApp) {
        setSelectedApp(newApp);
        setAppName("");
        setAppTitle("");
        setPrompt("");
        setSelectedTemplate(null);
        setTags([]);
      }
    } catch (error) {
      addLog(`Build failed: ${error.message}`);
    }
  };

  // Update and redeploy function using hook
  const handleUpdateAndRedeploy = async () => {
    try {
      const updatedApp = await appManagement.updateAndRedeploy({
        selectedApp,
        editCode,
        puter,
        tags
      });
      if (updatedApp) {
        setSelectedApp(updatedApp);
        setEditCode("");
      }
    } catch (error) {
      addLog(`Update failed: ${error.message}`);
    }
  };

  // Delete app function using hook
  const handleDeleteApp = async (app, e) => {
    e?.stopPropagation();
    try {
      await appManagement.deleteApp({ app, puter, versions });
      if (selectedApp?._id === app._id) {
        setSelectedApp(null);
        setEditCode("");
      }
    } catch (error) {
      addLog(`Delete failed: ${error.message}`);
    }
  };

  // Bulk delete function using hook
  const handleBulkDelete = async () => {
    await appManagement.bulkDelete(
      selectedApps, 
      apps, 
      puter, 
      versions, 
      setSelectedApps, 
      setBulkMode
    );
  };

  // Toggle favorite function using hook
  const handleToggleFavorite = async (app, e) => {
    e?.stopPropagation();
    await appManagement.toggleFavorite(app, setSelectedApp);
  };

  // Launch app function using hook
  const handleLaunchApp = async (app, e) => {
    e?.stopPropagation();
    await appManagement.launchApp(app, puter);
  };

  async function restoreVersion(version) {
    if (!selectedApp) return;
    setEditCode(version.code);
    addLog(`Restored v${version.version}`);
    setShowVersions(false);
  }
  
  function handleVersionSelect(version) {
    if (!selectedOldVersion || (selectedOldVersion && selectedNewVersion)) {
      setSelectedOldVersion(version);
      setSelectedNewVersion(null);
    } else if (selectedOldVersion && version._id !== selectedOldVersion._id) {
      setSelectedNewVersion(version);
    }
  }
  
  function resetDiffSelection() {
    setSelectedOldVersion(null);
    setSelectedNewVersion(null);
  }

  function exportApps() {
    const data = JSON.stringify(apps, null, 2);
    const blob = new Blob([data], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `puter-apps-export-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast("Apps exported successfully!", "success");
    setShowExportModal(false);
  }

  function exportSingleApp(app) {
    const data = JSON.stringify(app, null, 2);
    const blob = new Blob([data], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${app.appName || "app"}-export.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast(`Exported ${app.appName}!`, "success");
  }

  async function importApps(e) {
    const file = e.target.files[0];
    if (!file) return;
    const text = await file.text();
    try {
      const imported = JSON.parse(text);
      const appsToImport = Array.isArray(imported) ? imported : [imported];
      for (const app of appsToImport) {
        delete app._id;
        app.imported = true;
        app.createdAt = Date.now();
        await database.put(app);
      }
      showToast(`Imported ${appsToImport.length} app(s) successfully!`, "success");
    } catch (err) {
      showToast(`Import failed: ${err.message}`, "error");
    }
    e.target.value = "";
    setShowExportModal(false);
  }

  function generateShareLink(app) {
    const encoded = btoa(JSON.stringify({ 
      prompt: app.prompt, 
      code: app.code, 
      title: app.appTitle 
    }));
    const link = `${window.location.origin}?share=${encoded}`;
    setShareLink(link);
    setShowShareModal(true);
    
    // Generate QR code for the share link
    setQRCodeDataURL(""); // Clear previous QR code
    generateQRCode(link);
  }

  function copyShareLink() {
    navigator.clipboard.writeText(shareLink);
    showToast("Link copied to clipboard!", "success");
  }

  function generateQRCode(url) {
    setIsGeneratingQR(true);
    try {
      // Use QRCode library to generate QR code
      QRCode.toCanvas(url, {
        width: 256,
        margin: 2,
        color: {
          dark: '#000000',
          light: '#ffffff'
        }
      }, (error, canvas) => {
        setIsGeneratingQR(false);
        if (error) {
          console.error('QR Code generation error:', error);
          showToast('Failed to generate QR code', 'error');
          return;
        }
        
        // Convert canvas to data URL for display and download
        const dataURL = canvas.toDataURL('image/png');
        setQRCodeDataURL(dataURL);
      });
    } catch (error) {
      setIsGeneratingQR(false);
      console.error('QR Code generation error:', error);
      showToast('Failed to generate QR code', 'error');
    }
  }

  function downloadQRCode() {
    if (!qrCodeDataURL || !selectedApp) return;
    
    const link = document.createElement('a');
    link.download = `${selectedApp.appTitle || selectedApp.appName || 'app'}-qr-code.png`;
    link.href = qrCodeDataURL;
    link.click();
    
    showToast('QR Code downloaded!', 'success');
  }

  function selectTemplate(template) {
    setSelectedTemplate(template);
    setPrompt(template.prompt);
    setAppTitle(template.name);
    setShowTemplates(false);
    setActiveCategory("All"); // Reset to All when a template is selected
  }

  const appVersions = selectedApp ? versions.filter(v => v.appId === selectedApp._id).sort((a, b) => b.version - a.version) : [];

  // Neomorphic styles
  const lightNeu = "bg-[#e8e8e8] shadow-[8px_8px_16px_#c5c5c5,-8px_-8px_16px_#ffffff]";
  const lightNeuInset = "bg-[#e8e8e8] shadow-[inset_4px_4px_8px_#c5c5c5,inset_-4px_-4px_8px_#ffffff]";
  const lightNeuBtn = "bg-[#e8e8e8] shadow-[5px_5px_10px_#c5c5c5,-5px_-5px_10px_#ffffff] hover:shadow-[2px_2px_5px_#c5c5c5,-2px_-2px_5px_#ffffff] active:shadow-[inset_4px_4px_8px_#c5c5c5,inset_-4px_-4px_8px_#ffffff] transition-all duration-150";
  const lightNeuBtnRed = "bg-[#dc2626] text-white shadow-[5px_5px_10px_#c5c5c5,-5px_-5px_10px_#ffffff] hover:shadow-[2px_2px_5px_#c5c5c5,-2px_-2px_5px_#ffffff] active:shadow-[inset_4px_4px_8px_#b91c1c,inset_-4px_-4px_8px_#ef4444] transition-all duration-150";
  const lightNeuBtnBlack = "bg-[#1a1a1a] text-white shadow-[5px_5px_10px_#c5c5c5,-5px_-5px_10px_#ffffff] hover:shadow-[2px_2px_5px_#c5c5c5,-2px_-2px_5px_#ffffff] active:shadow-[inset_4px_4px_8px_#000,inset_-4px_-4px_8px_#333] transition-all duration-150";

  const darkNeu = "bg-[#2a2a2a] shadow-[8px_8px_16px_#1a1a1a,-8px_-8px_16px_#3a3a3a]";
  const darkNeuInset = "bg-[#2a2a2a] shadow-[inset_4px_4px_8px_#1a1a1a,inset_-4px_-4px_8px_#3a3a3a]";
  const darkNeuBtn = "bg-[#2a2a2a] shadow-[5px_5px_10px_#1a1a1a,-5px_-5px_10px_#3a3a3a] hover:shadow-[2px_2px_5px_#1a1a1a,-2px_-2px_5px_#3a3a3a] active:shadow-[inset_4px_4px_8px_#1a1a1a,inset_-4px_-4px_8px_#3a3a3a] transition-all duration-150";
  const darkNeuBtnRed = "bg-[#dc2626] text-white shadow-[5px_5px_10px_#1a1a1a,-5px_-5px_10px_#3a3a3a] hover:shadow-[2px_2px_5px_#1a1a1a,-2px_-2px_5px_#3a3a3a] active:shadow-[inset_4px_4px_8px_#b91c1c,inset_-4px_-4px_8px_#ef4444] transition-all duration-150";
  const darkNeuBtnBlack = "bg-[#1a1a1a] text-white shadow-[5px_5px_10px_#1a1a1a,-5px_-5px_10px_#3a3a3a] hover:shadow-[2px_2px_5px_#1a1a1a,-2px_-2px_5px_#3a3a3a] active:shadow-[inset_4px_4px_8px_#000,inset_-4px_-4px_8px_#333] transition-all duration-150";

  const neu = darkMode ? darkNeu : lightNeu;
  const neuInset = darkMode ? darkNeuInset : lightNeuInset;
  const neuBtn = darkMode ? darkNeuBtn : lightNeuBtn;
  const neuBtnRed = darkMode ? darkNeuBtnRed : lightNeuBtnRed;
  const neuBtnBlack = darkMode ? darkNeuBtnBlack : lightNeuBtnBlack;

  const bgMain = darkMode ? "bg-[#1a1a1a]" : "bg-[#e8e8e8]";
  const textPrimary = darkMode ? "text-[#e8e8e8]" : "text-[#1a1a1a]";
  const textSecondary = darkMode ? "text-[#cccccc]" : "text-[#666]";
  const textMuted = darkMode ? "text-[#888]" : "text-[#888]";
  






  // Test component that throws an error
  function ErrorTestComponent() {
    const throwError = () => {
      throw new Error('Intentional test error for ErrorBoundary');
    };
    
    return (
      <div className={`${neu} rounded-xl p-4 mb-4`}>
        <h3 className={`font-black ${textPrimary} mb-2`}>üß™ Error Boundary Test</h3>
        <p className={`${textSecondary} text-sm mb-3`}>Click the button below to test the ErrorBoundary:</p>
        <button onClick={throwError} className={`${neuBtnRed} rounded-xl px-4 py-2 font-bold text-sm`}>
          Trigger Test Error
        </button>
      </div>
    );
  }

  return (
    <>
      <ToastContainer toasts={toasts} removeToast={removeToast} />
      <div className={`min-h-screen ${bgMain} p-4 md:p-6 transition-colors duration-300`}>
      <div className="max-w-7xl mx-auto space-y-6">
        
        {/* Header */}
        <div className={`${neu} rounded-[24px] p-5`}>
          <div className="flex flex-wrap items-center justify-between gap-4">
            <div>
               <h1 className={`text-2xl md:text-3xl font-black ${textPrimary} flex items-center gap-2`}>
                 <span className="text-[#dc2626]">‚ö°</span> PUTER APP FACTORY
               </h1>
               <p className={`${textSecondary} text-sm mt-1`}>{models.length} models ‚Ä¢ {apps.length} apps ‚Ä¢ {analytics.totalViews} views</p>
             </div>
            <div className="flex items-center gap-3">
               <button onClick={() => setDarkMode(!darkMode)}
                 className={`${neuBtn} rounded-full px-4 py-2 font-bold ${textPrimary} text-sm`}>
                 {darkMode ? "‚òÄÔ∏è" : "üåô"}
               </button>
               <button onClick={() => setShowHelpModal(true)}
                 className={`${neuBtn} rounded-full px-4 py-2 font-bold ${textPrimary} text-sm`}>
                 ‚å®Ô∏è
               </button>
               {user && (
                 <>
                   <button onClick={() => setShowAnalytics(!showAnalytics)}
                     className={`${neuBtn} rounded-full px-4 py-2 font-bold ${textPrimary} text-sm`}>
                     üìä
                   </button>
                  <button onClick={() => setShowExportModal(true)}
                    className={`${neuBtn} rounded-full px-4 py-2 font-bold ${textPrimary} text-sm`}>
                    üì¶
                  </button>
                </>
              )}
              {user ? (
                <div className="flex items-center gap-3">
                  <div className={`${neuInset} rounded-full px-4 py-2`}>
                    <span className={`font-bold ${textPrimary} text-sm`}>üë§ {user.username}</span>
                  </div>
                  <button onClick={() => puterSDK.signOut()}
                    className={`${neuBtn} rounded-full px-4 py-2 font-bold ${textPrimary} text-sm`}>
                    Logout
                  </button>
                </div>
              ) : (
                <button onClick={() => puterSDK.signIn()} disabled={!puterSDK.sdkReady}
                  className={`${neuBtnRed} rounded-full px-6 py-3 font-black disabled:opacity-50`}>
                  Sign In Free
                </button>
              )}
            </div>
          </div>

          {/* Analytics Panel */}
          {showAnalytics && (
            <div className="mt-6 grid grid-cols-2 md:grid-cols-6 gap-4">
              {[
                { label: "Total Apps", value: analytics.totalApps, icon: "üì±" },
                { label: "Favorites", value: analytics.favorites, icon: "‚≠ê" },
                { label: "Total Views", value: analytics.totalViews, icon: "üëÅÔ∏è" },
                { label: "Models Used", value: analytics.modelsUsed, icon: "ü§ñ" },
                { label: "Avg Code Size", value: `${(analytics.avgCodeSize / 1024).toFixed(1)}KB`, icon: "üìÑ" },
                { label: "Versions", value: versions.length, icon: "üìö" },
              ].map((stat, i) => (
                <div key={i} className={`${neuInset} rounded-2xl p-4 text-center`}>
                  <div className="text-2xl mb-1">{stat.icon}</div>
                  <div className={`font-black ${textPrimary} text-xl`}>{stat.value}</div>
                  <div className={`${textSecondary} text-xs`}>{stat.label}</div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Error Test Component */}
        <ErrorTestComponent />

        {/* Export/Import Modal */}
        <ExportModal
          showExportModal={showExportModal}
          darkMode={darkMode}
          onClose={() => setShowExportModal(false)}
          onExportApps={exportApps}
          onImportApps={importApps}
          fileInputRef={fileInputRef}
        />

        {/* Share Modal */}
        {showShareModal && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowShareModal(false)}>
            <div className={`${neu} rounded-[24px] p-6 max-w-md w-full`} onClick={e => e.stopPropagation()}>
              <h3 className={`font-black ${textPrimary} text-xl mb-4`}>üîó Share App</h3>
              
              {/* Share Link Section */}
              <div className={`${neuInset} rounded-xl p-3 mb-4`}>
                <input value={shareLink} readOnly className={`w-full bg-transparent text-xs font-mono ${textPrimary} outline-none`} />
              </div>
              
              {/* QR Code Section */}
              <div className="mb-4">
                <h4 className={`font-bold ${textPrimary} text-sm mb-3 flex items-center gap-2`}>
                  üì± Mobile QR Code
                  <span className={`${textSecondary} text-xs`}>(Scan to open on mobile)</span>
                </h4>
                
                <div className={`${neuInset} rounded-xl p-4 flex flex-col items-center`}>
                  {isGeneratingQR ? (
                    <div className="flex flex-col items-center py-8">
                      <div className={`w-12 h-12 mx-auto mb-3 rounded-full ${neuInset} flex items-center justify-center animate-spin`}>
                        <span className="text-xl">‚öôÔ∏è</span>
                      </div>
                      <div className={`${textSecondary} text-sm`}>Generating QR Code...</div>
                    </div>
                  ) : qrCodeDataURL ? (
                    <div className="text-center">
                      <img 
                        src={qrCodeDataURL} 
                        alt="QR Code for app sharing" 
                        className="mx-auto mb-3 border-2 border-gray-200 rounded-lg"
                        style={{ width: '200px', height: '200px' }}
                      />
                      <button 
                        onClick={downloadQRCode}
                        className={`${neuBtn} rounded-xl py-2 px-4 font-bold ${textPrimary} text-sm flex items-center gap-2 mx-auto`}
                      >
                        üíæ Download QR Code
                      </button>
                    </div>
                  ) : (
                    <div className={`${textMuted} text-center py-4`}>
                      <div className="text-2xl mb-2">‚ö†Ô∏è</div>
                      <div className="text-sm">Failed to generate QR code</div>
                    </div>
                  )}
                </div>
              </div>
              
              {/* Action Buttons */}
              <div className="flex gap-3">
                <button onClick={copyShareLink} className={`flex-1 ${neuBtnRed} rounded-xl py-3 font-bold`}>
                  üìã Copy Link
                </button>
                <button onClick={() => setShowShareModal(false)} className={`flex-1 ${neuBtnBlack} rounded-xl py-3 font-bold`}>
                  Close
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Version History Modal */}
        {showVersions && selectedApp && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => { setShowVersions(false); resetDiffSelection(); }}>
            <div className={`${neu} rounded-[24px] p-6 max-w-4xl w-full max-h-[90vh] overflow-hidden`} onClick={e => e.stopPropagation()}>
              <div className="flex items-center justify-between mb-4">
                <h3 className={`font-black ${textPrimary} text-xl`}>üìö Version History & Diff Viewer</h3>
                <button onClick={() => { setShowVersions(false); resetDiffSelection(); }} className={`${neuBtn} rounded-full w-8 h-8 flex items-center justify-center text-sm ${textPrimary}`}>
                  √ó
                </button>
              </div>
              
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 max-h-[70vh] overflow-hidden">
                {/* Version List */}
                <div className="space-y-4">
                  <div className="flex items-center justify-between">
                    <h4 className={`font-bold ${textPrimary}`}>Versions</h4>
                    {selectedOldVersion && selectedNewVersion && (
                      <button onClick={resetDiffSelection} className={`${neuBtn} rounded-full px-3 py-1 text-xs font-bold ${textPrimary}`}>
                        Clear Selection
                      </button>
                    )}
                  </div>
                  <div className="space-y-2 max-h-[50vh] overflow-y-auto">
                    {appVersions.length === 0 ? (
                      <p className={`${textSecondary} text-center py-4`}>No versions saved yet</p>
                    ) : (
                      appVersions.map(v => {
                        const isOldSelected = selectedOldVersion?._id === v._id;
                        const isNewSelected = selectedNewVersion?._id === v._id;
                        const isDisabled = selectedOldVersion && !selectedNewVersion && isOldSelected;
                        
                        return (
                          <div key={v._id} className={`${neuInset} rounded-xl p-3 transition-all ${
                            isOldSelected || isNewSelected ? 'ring-2 ring-[#dc2626]' : ''
                          }`}>
                            <div className="flex justify-between items-center">
                              <div className="flex-1">
                                <div className={`font-bold ${textPrimary} flex items-center gap-2`}>
                                  Version {v.version}
                                  {isOldSelected && <span className="text-xs bg-[#dc2626] text-white px-2 py-1 rounded-full">Old</span>}
                                  {isNewSelected && <span className="text-xs bg-[#22c55e] text-white px-2 py-1 rounded-full">New</span>}
                                </div>
                                <div className={`${textSecondary} text-xs`}>{new Date(v.createdAt).toLocaleString()}</div>
                              </div>
                              <div className="flex gap-2">
                                <button 
                                  onClick={() => handleVersionSelect(v)}
                                  disabled={isDisabled}
                                  className={`${neuBtn} rounded-full px-3 py-1 text-xs font-bold ${textPrimary} disabled:opacity-50`}
                                >
                                  {isOldSelected || isNewSelected ? 'Selected' : 'Select'}
                                </button>
                                <button onClick={() => restoreVersion(v)} className={`${neuBtn} rounded-full px-3 py-1 text-xs font-bold ${textPrimary}`}>
                                  Restore
                                </button>
                              </div>
                            </div>
                          </div>
                        );
                      })
                    )}
                  </div>
                </div>
                
                {/* Diff Viewer */}
                <div className="space-y-4">
                  <div className="flex items-center justify-between">
                    <h4 className={`font-bold ${textPrimary}`}>Diff Viewer</h4>
                    {selectedOldVersion && selectedNewVersion && (
                      <div className="flex gap-2">
                        <button 
                          onClick={() => setDiffViewMode('unified')}
                          className={`px-3 py-1 rounded-full text-xs font-bold transition-all ${
                            diffViewMode === 'unified' 
                              ? 'bg-[#dc2626] text-white shadow-[inset_2px_2px_4px_#b91c1c,inset_-2px_-2px_4px_#ef4444]' 
                              : `${neuBtn} ${textPrimary}`
                          }`}
                        >
                          Unified
                        </button>
                        <button 
                          onClick={() => setDiffViewMode('side-by-side')}
                          className={`px-3 py-1 rounded-full text-xs font-bold transition-all ${
                            diffViewMode === 'side-by-side' 
                              ? 'bg-[#dc2626] text-white shadow-[inset_2px_2px_4px_#b91c1c,inset_-2px_-2px_4px_#ef4444]' 
                              : `${neuBtn} ${textPrimary}`
                          }`}
                        >
                          Side-by-Side
                        </button>
                      </div>
                    )}
                  </div>
                  
                  {selectedOldVersion && selectedNewVersion ? (
                    <VersionDiff 
                      oldVersion={selectedOldVersion} 
                      newVersion={selectedNewVersion} 
                      viewMode={diffViewMode}
                      darkMode={darkMode}
                    />
                  ) : (
                    <div className={`${neuInset} rounded-xl p-8 text-center`}>
                      <div className="text-4xl mb-4">üîç</div>
                      <div className={`${textSecondary} mb-2`}>Select two versions to compare</div>
                      <div className={`${textMuted} text-sm`}>
                        Choose an "Old" version first, then a "New" version to see the differences
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Templates Modal */}
        {showTemplates && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowTemplates(false)}>
            <div className={`${neu} rounded-[24px] p-6 max-w-2xl w-full max-h-[80vh] overflow-hidden`} onClick={e => e.stopPropagation()}>
              <h3 className={`font-black ${textPrimary} text-xl mb-4`}>üé® App Templates</h3>
              
              {/* Category Tabs */}
              <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                {getCategories().map(category => (
                  <button key={category} onClick={() => setActiveCategory(category)}
                    className={`px-4 py-2 rounded-full text-sm font-bold transition-all whitespace-nowrap ${
                      activeCategory === category
                        ? `${neuInset} text-[#dc2626]`
                        : `${neuBtn} ${textPrimary}`}`}>
                    {category === "All" ? "üåê All" : category}
                  </button>
                ))}
              </div>
              
              <div className="grid grid-cols-2 md:grid-cols-3 gap-3 max-h-[55vh] overflow-y-auto">
                {filteredTemplates.map(t => (
                  <button key={t.id} onClick={() => selectTemplate(t)}
                    className={`${neuBtn} rounded-xl p-4 text-left transition-all ${selectedTemplate?.id === t.id ? "ring-2 ring-[#dc2626]" : ""}`}>
                    <div className="text-3xl mb-2">{t.icon}</div>
                    <div className={`font-bold ${textPrimary} text-sm`}>{t.name}</div>
                    <div className={`text-xs ${textSecondary} mt-1`}>{t.category}</div>
                  </button>
                ))}
              </div>
              <button onClick={() => setShowTemplates(false)} className={`w-full ${neuBtnBlack} rounded-xl py-3 font-bold mt-4`}>
                Close
              </button>
            </div>
          </div>
        )}

        {/* Keyboard Shortcuts Help Modal */}
        {showHelpModal && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowHelpModal(false)}>
            <div className={`${neu} rounded-[24px] p-6 max-w-md w-full`} onClick={e => e.stopPropagation()}>
              <h3 className={`font-black ${textPrimary} text-xl mb-4`}>‚å®Ô∏è Keyboard Shortcuts</h3>
              <div className="space-y-3">
                <div className={`${neuInset} rounded-xl p-3 flex justify-between items-center`}>
                  <span className={`${textPrimary} font-medium`}>Focus Search</span>
                  <div className="flex gap-1">
                    <kbd className={`px-2 py-1 rounded text-xs font-mono ${darkMode ? "bg-[#1a1a1a]" : "bg-[#fff]"} border`}>Ctrl</kbd>
                    <span className={`${textSecondary} text-xs`}>+</span>
                    <kbd className={`px-2 py-1 rounded text-xs font-mono ${darkMode ? "bg-[#1a1a1a]" : "bg-[#fff]"} border`}>K</kbd>
                    <span className={`${textSecondary} text-xs`}>or</span>
                    <kbd className={`px-2 py-1 rounded text-xs font-mono ${darkMode ? "bg-[#1a1a1a]" : "bg-[#fff]"} border`}>‚åò</kbd>
                    <span className={`${textSecondary} text-xs`}>+</span>
                    <kbd className={`px-2 py-1 rounded text-xs font-mono ${darkMode ? "bg-[#1a1a1a]" : "bg-[#fff]"} border`}>K</kbd>
                  </div>
                </div>
                <div className={`${neuInset} rounded-xl p-3 flex justify-between items-center`}>
                  <span className={`${textPrimary} font-medium`}>Switch to Build Tab</span>
                  <div className="flex gap-1">
                    <kbd className={`px-2 py-1 rounded text-xs font-mono ${darkMode ? "bg-[#1a1a1a]" : "bg-[#fff]"} border`}>Ctrl</kbd>
                    <span className={`${textSecondary} text-xs`}>+</span>
                    <kbd className={`px-2 py-1 rounded text-xs font-mono ${darkMode ? "bg-[#1a1a1a]" : "bg-[#fff]"} border`}>B</kbd>
                    <span className={`${textSecondary} text-xs`}>or</span>
                    <kbd className={`px-2 py-1 rounded text-xs font-mono ${darkMode ? "bg-[#1a1a1a]" : "bg-[#fff]"} border`}>‚åò</kbd>
                    <span className={`${textSecondary} text-xs`}>+</span>
                    <kbd className={`px-2 py-1 rounded text-xs font-mono ${darkMode ? "bg-[#1a1a1a]" : "bg-[#fff]"} border`}>B</kbd>
                  </div>
                </div>
                <div className={`${neuInset} rounded-xl p-3 flex justify-between items-center`}>
                  <span className={`${textPrimary} font-medium`}>Save/Redeploy</span>
                  <div className="flex gap-1">
                    <kbd className={`px-2 py-1 rounded text-xs font-mono ${darkMode ? "bg-[#1a1a1a]" : "bg-[#fff]"} border`}>Ctrl</kbd>
                    <span className={`${textSecondary} text-xs`}>+</span>
                    <kbd className={`px-2 py-1 rounded text-xs font-mono ${darkMode ? "bg-[#1a1a1a]" : "bg-[#fff]"} border`}>S</kbd>
                    <span className={`${textSecondary} text-xs`}>or</span>
                    <kbd className={`px-2 py-1 rounded text-xs font-mono ${darkMode ? "bg-[#1a1a1a]" : "bg-[#fff]"} border`}>‚åò</kbd>
                    <span className={`${textSecondary} text-xs`}>+</span>
                    <kbd className={`px-2 py-1 rounded text-xs font-mono ${darkMode ? "bg-[#1a1a1a]" : "bg-[#fff]"} border`}>S</kbd>
                  </div>
                </div>
                <div className={`${neuInset} rounded-xl p-3 flex justify-between items-center`}>
                  <span className={`${textPrimary} font-medium`}>Close Modals</span>
                  <div className="flex gap-1">
                    <kbd className={`px-2 py-1 rounded text-xs font-mono ${darkMode ? "bg-[#1a1a1a]" : "bg-[#fff]"} border`}>Esc</kbd>
                  </div>
                </div>
                <div className={`${neuInset} rounded-xl p-3 flex justify-between items-center`}>
                  <span className={`${textPrimary} font-medium`}>Show Help</span>
                  <div className="flex gap-1">
                    <kbd className={`px-2 py-1 rounded text-xs font-mono ${darkMode ? "bg-[#1a1a1a]" : "bg-[#fff]"} border`}>Ctrl</kbd>
                    <span className={`${textSecondary} text-xs`}>+</span>
                    <kbd className={`px-2 py-1 rounded text-xs font-mono ${darkMode ? "bg-[#1a1a1a]" : "bg-[#fff]"} border`}>?</kbd>
                    <span className={`${textSecondary} text-xs`}>or</span>
                    <kbd className={`px-2 py-1 rounded text-xs font-mono ${darkMode ? "bg-[#1a1a1a]" : "bg-[#fff]"} border`}>‚åò</kbd>
                    <span className={`${textSecondary} text-xs`}>+</span>
                    <kbd className={`px-2 py-1 rounded text-xs font-mono ${darkMode ? "bg-[#1a1a1a]" : "bg-[#fff]"} border`}>?</kbd>
                  </div>
                </div>
              </div>
              <button onClick={() => setShowHelpModal(false)} className={`w-full ${neuBtnBlack} rounded-xl py-3 font-bold mt-4`}>
                Close
              </button>
            </div>
          </div>
        )}

        {!user ? (
          <div className={`${neu} rounded-[32px] p-12 text-center`}>
            <div className="w-24 h-24 mx-auto mb-6 rounded-full bg-[#dc2626] flex items-center justify-center shadow-[inset_4px_4px_8px_#b91c1c,inset_-4px_-4px_8px_#ef4444]">
              <span className="text-5xl">üöÄ</span>
            </div>
            <h2 className={`text-3xl font-black ${textPrimary} mb-3`}>Build & Deploy Puter Apps</h2>
            <p className={`${textSecondary} mb-8 max-w-md mx-auto`}>
              Describe your app ‚Üí AI builds it ‚Üí Deploy as a real Puter app with live URL
            </p>
            <button onClick={() => puterSDK.signIn()} disabled={!puterSDK.sdkReady}
              className={`${neuBtnRed} rounded-full px-10 py-4 font-black text-lg disabled:opacity-50`}>
              Get Started Free
            </button>
          </div>
        ) : (
          <div className="grid lg:grid-cols-3 gap-6">
            
            {/* Left Panel */}
            <div className="space-y-6">
              {/* Tabs */}
              <div className={`${neu} rounded-[24px] p-2 flex gap-2`}>
                {[
                  { id: "build", label: "Build", icon: "üî®" },
                  { id: "apps", label: "Apps", icon: "üì±" },
                ].map(tab => (
                  <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                    className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all ${
                      activeTab === tab.id ? `${neuInset} text-[#dc2626]` : `${neuBtn} ${textPrimary}`}`}>
                    {tab.icon} {tab.label}
                  </button>
                ))}
              </div>

              {activeTab === "build" && (
                <div className={`${neu} rounded-[24px] p-5`}>
                  <button onClick={() => setShowTemplates(true)}
                    className={`w-full ${neuBtn} rounded-xl py-3 font-bold ${textPrimary} mb-4 flex items-center justify-center gap-2`}>
                    üé® Choose Template
                  </button>

                  {selectedTemplate && (
                    <div className={`${neuInset} rounded-xl p-3 mb-4 flex items-center gap-3`}>
                      <span className="text-2xl">{selectedTemplate.icon}</span>
                      <div>
                        <div className={`font-bold ${textPrimary} text-sm`}>{selectedTemplate.name}</div>
                        <button onClick={() => { setSelectedTemplate(null); setPrompt(""); }} className="text-[#dc2626] text-xs">Clear</button>
                      </div>
                    </div>
                  )}
                  
                  <div className="mb-4">
                    <label className={`font-black ${textPrimary} text-xs uppercase tracking-wider mb-2 block`}>Provider</label>
                    <div className="flex flex-wrap gap-2">
                      {providers.slice(0, 6).map(p => (
                        <button key={p} onClick={() => setProvider(p)}
                          className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all ${
                            provider === p
                              ? "bg-[#dc2626] text-white shadow-[inset_2px_2px_4px_#b91c1c,inset_-2px_-2px_4px_#ef4444]"
                              : `${neuBtn} ${textPrimary}`}`}>
                          {p}
                        </button>
                      ))}
                    </div>
                  </div>

                  <div className="mb-4">
                    <label className={`font-black ${textPrimary} text-xs uppercase tracking-wider mb-2 block`}>Model</label>
                    <div className={`${neuInset} rounded-2xl p-1`}>
                      <select value={model} onChange={e => setModel(e.target.value)}
                        className={`w-full p-3 bg-transparent font-mono text-sm ${textPrimary} border-0 outline-none`}>
                        {filtered.map(m => <option key={m.id} value={m.id}>{m.id}</option>)}
                      </select>
                    </div>
                  </div>

                  <div className="mb-4">
                    <label className={`font-black ${textPrimary} text-xs uppercase tracking-wider mb-2 block`}>App Description</label>
                    <div className={`${neuInset} rounded-2xl p-1`}>
                      <textarea value={prompt} onChange={e => setPrompt(e.target.value)}
                        placeholder="Describe your app in detail..."
                        className={`w-full h-24 p-3 bg-transparent font-mono text-sm ${textPrimary} resize-none border-0 outline-none placeholder-[#999]`}
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-3 mb-4">
                    <div>
                      <label className={`font-black ${textPrimary} text-xs uppercase tracking-wider mb-2 block`}>App Name</label>
                      <div className={`${neuInset} rounded-xl p-1`}>
                        <input value={appName} onChange={e => setAppName(e.target.value.toLowerCase().replace(/[^a-z0-9-]/g, ""))}
                          placeholder="my-app"
                          className={`w-full p-2 bg-transparent font-mono text-sm ${textPrimary} border-0 outline-none placeholder-[#999]`}
                        />
                      </div>
                    </div>
                    <div>
                      <label className={`font-black ${textPrimary} text-xs uppercase tracking-wider mb-2 block`}>Title</label>
                      <div className={`${neuInset} rounded-xl p-1`}>
                        <input value={appTitle} onChange={e => setAppTitle(e.target.value)}
                          placeholder="My App"
                          className={`w-full p-2 bg-transparent text-sm ${textPrimary} border-0 outline-none placeholder-[#999]`}
                        />
                      </div>
                    </div>
                  </div>

                  {/* Tags Input */}
                  <div className="mb-4">
                    <label className={`font-black ${textPrimary} text-xs uppercase tracking-wider mb-2 block`}>Tags</label>
                    <div className={`${neuInset} rounded-2xl p-1`}>
                      <div className="flex flex-wrap gap-2 p-2">
                        {tags.map((tag, index) => (
                          <div key={index} className={`flex items-center gap-2 ${neuBtn} rounded-full px-3 py-1 text-sm`}>
                            <span className={textPrimary}>{tag}</span>
                            <button onClick={(e) => { e.stopPropagation(); removeTag(tag); }}
                              className="text-[#dc2626] hover:text-[#ef4444] transition-colors">
                              √ó
                            </button>
                          </div>
                        ))}
                        <div className="flex-1 min-w-[120px]">
                          <input value={tagInput} onChange={(e) => setTagInput(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && addTag()}
                            placeholder="Add tag..."
                            className={`w-full p-2 bg-transparent text-sm ${textPrimary} border-0 outline-none placeholder-[#999]`}
                          />
                        </div>
                        <button onClick={addTag}
                          className={`${neuBtnRed} rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold`}>
                          +
                        </button>
                      </div>
                    </div>
                  </div>

                  <button onClick={() => handleBuildAndDeploy()} disabled={generating || !prompt.trim()}
                    className={`w-full ${neuBtnRed} rounded-2xl py-4 font-black text-lg disabled:opacity-50`}>
                    {generating ? "‚è≥ Building..." : "üöÄ Build & Deploy"}
                  </button>
                </div>
              )}

              {activeTab === "apps" && (
                <div className={`${neu} rounded-[24px] overflow-hidden`}>
                  {/* Search & Filters */}
                  <div className="p-4 space-y-3">
                    <div className={`${neuInset} rounded-xl p-1 flex items-center`}>
                      <span className="pl-3 text-[#999]">üîç</span>
                      <input value={searchQuery} onChange={e => setSearchQuery(e.target.value)}
                        placeholder="Search apps..."
                        className={`flex-1 p-2 bg-transparent text-sm ${textPrimary} border-0 outline-none placeholder-[#999]`}
                      />
                    </div>
                    <div className="flex gap-2 flex-wrap">
                      <button onClick={() => setFilterFavorites(!filterFavorites)}
                        className={`px-3 py-1.5 rounded-full text-xs font-bold ${filterFavorites ? "bg-[#dc2626] text-white" : neuBtn + " " + textPrimary}`}>
                        ‚≠ê Favorites
                      </button>
                      <select value={sortBy} onChange={e => setSortBy(e.target.value)}
                        className={`${neuBtn} rounded-full px-3 py-1.5 text-xs font-bold ${textPrimary} outline-none`}>
                        <option value="date">Recent</option>
                        <option value="name">Name</option>
                        <option value="views">Views</option>
                      </select>
                      <button onClick={() => setBulkMode(!bulkMode)}
                        className={`px-3 py-1.5 rounded-full text-xs font-bold ${bulkMode ? "bg-[#1a1a1a] text-white" : neuBtn + " " + textPrimary}`}>
                        ‚òëÔ∏è Select
                      </button>
                    </div>
                    {bulkMode && selectedApps.size > 0 && (
                      <button onClick={handleBulkDelete} className={`${neuBtnRed} rounded-xl w-full py-2 text-sm font-bold text-white`}>
                        üóëÔ∏è Delete {selectedApps.size} Selected
                      </button>
                    )}
                    {/* Tag Filters */}
                    {getAllTags().length > 0 && (
                      <div className="flex flex-wrap gap-2 mt-2">
                        {getAllTags().map(tag => (
                          <button key={tag} onClick={() => toggleTagFilter(tag)}
                            className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all ${
                              selectedTags.includes(tag)
                                ? "bg-[#dc2626] text-white"
                                : neuBtn + " " + textPrimary}`}>
                            #{tag}
                          </button>
                        ))}
                        {selectedTags.length > 0 && (
                          <button onClick={() => setSelectedTags([])}
                            className={`${neuBtnRed} rounded-full px-3 py-1.5 text-xs font-bold`}>
                            Clear Filters
                          </button>
                        )}
                      </div>
                    )}
                  </div>

                  {/* Virtualized App List */}
                  <div className="max-h-96">
                    {filteredApps.length === 0 ? (
                      <div className={`p-6 ${textMuted} text-center`}>
                        {deferredSearchQuery || filterFavorites ? "No matching apps" : "No apps yet"}
                      </div>
                    ) : (
                      <AppList
                        height={384} // max-h-96 = 24rem = 384px
                        itemCount={filteredApps.length}
                        itemSize={140} // Approximate height for each app card
                        itemData={filteredApps}
                        className="overflow-y-auto"
                      >
                        {({ index, style, data }) => {
                          const app = data[index];
                          return (
                            <div
                              key={app._id}
                              style={style}
                              onClick={() => { if (!bulkMode) { setSelectedApp(app); setEditCode(""); setTags(app.tags || []); }}}
                              className={`p-4 border-b border-[#d0d0d0] cursor-pointer transition-all ${
                                selectedApp?._id === app._id ? neuInset : "hover:bg-[#ddd]"
                              }`}
                            >
                              <div className="flex items-start gap-3">
                                {bulkMode && (
                                  <input
                                    type="checkbox"
                                    checked={selectedApps.has(app._id)}
                                    onChange={e => {
                                      e.stopPropagation();
                                      const newSet = new Set(selectedApps);
                                      e.target.checked ? newSet.add(app._id) : newSet.delete(app._id);
                                      setSelectedApps(newSet);
                                    }}
                                    className="mt-1 w-5 h-5"
                                  />
                                )}
                                <div className="min-w-0 flex-1">
                                  <div className={`font-black ${textPrimary} flex items-center gap-2`}>
                                    <span className="text-[#dc2626]">üì±</span>
                                    {app.appTitle || app.appName}
                                    {app.favorite && <span>‚≠ê</span>}
                                  </div>
                                  <div className={`${textSecondary} text-xs flex items-center gap-2 mt-1`}>
                                    <span>v{app.version || 1}</span>
                                    <span>‚Ä¢</span>
                                    <span>üëÅÔ∏è {app.views || 0}</span>
                                  </div>
                                  <div className={`${textMuted} text-xs mt-1 truncate`}>{app.prompt}</div>
                                  {/* Tag Chips */}
                                  {app.tags && app.tags.length > 0 && (
                                    <div className="flex flex-wrap gap-1 mt-2">
                                      {app.tags.map((tag, tagIndex) => (
                                        <span key={tagIndex} className={`px-2 py-1 rounded-full text-xs font-bold ${neuBtn} ${textSecondary}`}>
                                          #{tag}
                                        </span>
                                      ))}
                                    </div>
                                  )}
                                </div>
                                {!bulkMode && (
                                  <div className="flex flex-col gap-1">
                                    <button
                                      onClick={e => handleToggleFavorite(app, e)}
                                      className={`${neuBtn} rounded-full w-8 h-8 flex items-center justify-center text-sm ${textPrimary}`}
                                    >
                                      {app.favorite ? "‚≠ê" : "‚òÜ"}
                                    </button>
                                    <button
                                      onClick={e => handleDuplicateApp(app, e)}
                                      className={`${neuBtn} rounded-full w-8 h-8 flex items-center justify-center text-xs`}
                                      title="Duplicate"
                                    >
                                      üìã
                                    </button>
                                    <button
                                      onClick={e => handleLaunchApp(app, e)}
                                      className={`${neuBtnBlack} rounded-full w-8 h-8 flex items-center justify-center text-xs`}
                                    >
                                      ‚ñ∂
                                    </button>
                                  </div>
                                )}
                              </div>
                            </div>
                          );
                        }}
                      </AppList>
                    )}
                  </div>
                </div>
              )}

              {/* Log */}
              {log.length > 0 && (
                <div className={`${neuInset} rounded-2xl p-4`}>
                  <div className={`${textSecondary} font-mono text-xs space-y-1 max-h-32 overflow-y-auto`}>
                    {log.map((l, i) => (
                      <div key={i} className={l.includes("‚úÖ") ? "text-green-600" : l.includes("‚ùå") ? "text-red-600" : ""}>
                        {l}
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* Preview Panel */}
            <div className="lg:col-span-2 space-y-6">
              {/* AI Chat Panel */}
              {selectedApp && <ChatPanel />}
              <div className={`${neu} rounded-[24px] overflow-hidden`}>
                <div className="bg-[#1a1a1a] p-4 flex items-center justify-between flex-wrap gap-3">
                  <div className="flex items-center gap-3">
                    <div className="flex gap-2">
                      <div className="w-3 h-3 rounded-full bg-[#dc2626]"></div>
                      <div className="w-3 h-3 rounded-full bg-[#fbbf24]"></div>
                      <div className="w-3 h-3 rounded-full bg-[#22c55e]"></div>
                    </div>
                    <span className="text-white font-black text-sm">
                      {selectedApp?.appTitle || selectedApp?.appName || "PREVIEW"}
                    </span>
                    {selectedApp && (
                      <span className="text-[#cccccc] text-xs">v{selectedApp.version || 1}</span>
                    )}
                  </div>
                  <div className="flex gap-2 flex-wrap">
                  {selectedApp && (
                    <>
                      <button onClick={() => setShowVersions(true)}
                        className={`${neuBtn} rounded-full px-3 py-2 font-bold text-xs ${textPrimary}`}>
                        üìö
                      </button>
                      <button onClick={() => generateShareLink(selectedApp)}
                        className={`${neuBtn} rounded-full px-3 py-2 font-bold text-xs ${textPrimary}`}>
                        üîó
                      </button>
                      <button onClick={() => exportSingleApp(selectedApp)}
                        className={`${neuBtn} rounded-full px-3 py-2 font-bold text-xs ${textPrimary}`}>
                        üì§
                      </button>
                      
                      {/* Zoom Controls */}
                      <div className={`${neuInset} rounded-full px-3 py-2 flex items-center gap-2`}>
                        <button onClick={zoomOut} disabled={previewZoom <= 0.25}
                          className={`${neuBtn} rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold ${textPrimary} disabled:opacity-50`}>
                          -
                        </button>
                        <span className={`font-mono text-xs ${textPrimary} min-w-[3rem] text-center`}>
                          {Math.round(previewZoom * 100)}%
                        </span>
                        <button onClick={zoomIn} disabled={previewZoom >= 3.0}
                          className={`${neuBtn} rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold ${textPrimary} disabled:opacity-50`}>
                          +
                        </button>
                        <button onClick={resetZoom}
                          className={`${neuBtn} rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold ${textPrimary}`}>
                          ‚åÇ
                        </button>
                      </div>
                    </>
                  )}
                  <button onClick={() => setShowCode(!showCode)} disabled={!displayCode}
                    className={`${neuBtn} rounded-full px-4 py-2 font-bold text-xs ${textPrimary} disabled:opacity-50`}>
                    {showCode ? "Preview" : "</>"}
                  </button>
                  <button onClick={() => setIsChatVisible(!isChatVisible)}
                    className={`${neuBtn} rounded-full px-4 py-2 font-bold text-xs ${isChatVisible ? "bg-[#22c55e] text-white" : textPrimary} disabled:opacity-50`}>
                    üí¨
                  </button>
                  {selectedApp && (
                    <button onClick={e => handleLaunchApp(selectedApp, e)}
                      className={`${neuBtnBlack} rounded-full px-4 py-2 font-bold text-xs`}>
                      Launch
                    </button>
                  )}
                  {selectedApp && editCode && (
                    <button onClick={handleUpdateAndRedeploy} disabled={generating}
                      className={`${neuBtnRed} rounded-full px-4 py-2 font-bold text-xs disabled:opacity-50`}>
                      Redeploy
                    </button>
                  )}
                </div>
                </div>
                
                <div className="h-[480px] bg-white">
                  {showCode && displayCode ? (
                    <div className="relative h-full">
                      {monacoLoading ? (
                        <div className="h-full flex items-center justify-center">
                          <div className="text-center">
                            <div className={`w-16 h-16 mx-auto mb-4 rounded-full ${neuInset} flex items-center justify-center animate-spin`}>
                              <span className="text-2xl">‚öôÔ∏è</span>
                            </div>
                            <div className={`font-black ${textPrimary} text-lg`}>Loading Editor...</div>
                          </div>
                        </div>
                      ) : monacoError ? (
                        <div className="h-full flex items-center justify-center">
                          <div className="text-center">
                            <div className={`w-16 h-16 mx-auto mb-4 rounded-full ${neuInset} flex items-center justify-center`}>
                              <span className="text-2xl">‚ö†Ô∏è</span>
                            </div>
                            <div className={`font-black ${textPrimary} text-lg mb-2`}>Editor Error</div>
                            <div className={`${textSecondary} text-sm mb-4`}>{monacoError}</div>
                            <button 
                              onClick={() => setShowCode(false)}
                              className={`${neuBtn} rounded-xl px-4 py-2 font-bold ${textPrimary} text-sm`}>
                              Back to Preview
                            </button>
                          </div>
                        </div>
                      ) : (
                        <>
                          <div 
                            id="monaco-editor" 
                            className="w-full h-full"
                            ref={monacoEditorRef}
                          />
                          <div className="absolute bottom-2 right-2 text-[#666] text-xs">
                            {(editCode || selectedApp?.code || "").length} chars
                          </div>
                        </>
                      )}
                    </div>
                  ) : displayCode ? (
                    <div className="w-full h-full overflow-auto" style={{
                      transform: `scale(${previewZoom})`,
                      transformOrigin: 'top left',
                      transition: 'transform 0.2s ease-in-out'
                    }}>
                      <iframe
                        srcDoc={editCode || selectedApp?.code}
                        className="w-full h-full border-0"
                        sandbox="allow-scripts allow-forms allow-modals allow-popups"
                        onLoad={(e) => {
                          try {
                            // Ensure iframe can't access parent localStorage
                            const iframeDoc = e.target?.contentDocument;
                            if (iframeDoc) {
                              iframeDoc.documentElement.setAttribute('data-sandboxed', 'true');
                            }
                          } catch (error) {
                            console.warn('Cannot access iframe document:', error);
                          }
                        }}
                        style={{
                          width: `${100 / previewZoom}%`,
                          height: `${100 / previewZoom}%`,
                          minWidth: `${100 / previewZoom}%`,
                          minHeight: `${100 / previewZoom}%`
                        }}
                      />
                    </div>
                  ) : (
                    <div className="h-full flex items-center justify-center">
                      <div className="text-center">
                        {generating ? (
                          <div className={`w-20 h-20 mx-auto mb-4 rounded-full ${neuInset} flex items-center justify-center`}>
                            <span className="text-3xl animate-spin">‚öôÔ∏è</span>
                          </div>
                        ) : (
                          <div className={`w-20 h-20 mx-auto mb-4 rounded-full ${neu} flex items-center justify-center`}>
                            <span className="text-3xl">üì±</span>
                          </div>
                        )}
                        <div className={`font-black ${textPrimary} text-lg`}>
                          {generating ? "BUILDING..." : "APP PREVIEW"}
                        </div>
                        {generating && generationStage && (
                          <div className={`${textSecondary} text-sm mt-2`}>{generationStage}</div>
                        )}
                        {!generating && (
                          <div className={`${textMuted} text-sm mt-2`}>Build or select an app</div>
                        )}
                      </div>
                    </div>
                  )}
                </div>
              </div>

              {/* App Details Card */}
              {selectedApp && (
                <div className={`${neu} rounded-[24px] p-5`}>
                  <div className="flex flex-wrap items-start justify-between gap-4">
                    <div className="flex-1 min-w-0">
                      <h3 className={`font-black ${textPrimary} text-xl flex items-center gap-2`}>
                        <span className="text-[#dc2626]">üì±</span>
                        {selectedApp.appTitle || selectedApp.appName}
                        {selectedApp.favorite && <span>‚≠ê</span>}
                      </h3>
                      <div className={`${textSecondary} text-sm mt-3 space-y-1`}>
                        <div className="flex gap-4 flex-wrap">
                          <span><strong>ID:</strong> <span className="font-mono">{selectedApp.appName}</span></span>
                          <span><strong>Version:</strong> {selectedApp.version || 1}</span>
                          <span><strong>Views:</strong> {selectedApp.views || 0}</span>
                        </div>
                        <div><strong>URL:</strong> <a href={selectedApp.hostedUrl} target="_blank" className="text-[#dc2626] hover:underline">{selectedApp.hostedUrl}</a></div>
                        <div><strong>Model:</strong> {selectedApp.model}</div>
                        {/* Tags in App Details */}
                        {selectedApp.tags && selectedApp.tags.length > 0 && (
                          <div className="mt-2">
                            <strong>Tags:</strong>
                            <div className="flex flex-wrap gap-2 mt-1">
                              {selectedApp.tags.map((tag, tagIndex) => (
                                <span key={tagIndex} className={`px-3 py-1 rounded-full text-xs font-bold ${neuBtn} ${textPrimary}`}>
                                  #{tag}
                                </span>
                              ))}
                            </div>
                          </div>
                        )}
                        <div className={`${textMuted} text-xs mt-2`}>{selectedApp.prompt}</div>
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={e => handleToggleFavorite(selectedApp, e)}
                        className={`${neuBtn} rounded-full w-12 h-12 flex items-center justify-center text-xl ${textPrimary}`}>
                        {selectedApp.favorite ? "‚≠ê" : "‚òÜ"}
                      </button>
                      <button onClick={e => handleDuplicateApp(selectedApp, e)}
                        className={`${neuBtn} rounded-full w-12 h-12 flex items-center justify-center text-xl ${textPrimary}`}
                        title="Duplicate App">
                        üìã
                      </button>
                      <button onClick={e => handleLaunchApp(selectedApp, e)}
                        className={`${neuBtnRed} rounded-2xl px-6 py-3 font-black`}>
                        üöÄ Launch
                      </button>
                      <button onClick={e => handleDeleteApp(selectedApp, e)}
                        className={`${neuBtn} rounded-full w-12 h-12 flex items-center justify-center text-xl text-[#dc2626]`}>
                        üóëÔ∏è
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Footer */}
        <div className="text-center py-4">
          <div className={`inline-flex items-center gap-2 ${textMuted} text-sm`}>
            <span className="w-2 h-2 rounded-full bg-[#dc2626]"></span>
            Powered by Puter
            <span className="w-2 h-2 rounded-full bg-[#1a1a1a]"></span>
          </div>
        </div>
      </div>
    </div>
    </>
  );
}
      // prettier-ignore-end

      const rootElement = document.getElementById("container");
      ReactDOMClient.createRoot(rootElement).render(
        <ErrorBoundary>
          <App />
        </ErrorBoundary>
      );
    </script>
    <!--
    Agents see LLMs docs:
      Database: https://use-fireproof.com/llms-full.txt
      CallAI: https://use-fireproof.com/callai-llms.txt
      ImgGen: https://use-fireproof.com/imggen-llms.txt
    -->
    <script>
      // Test the tag system implementation
      console.log("Tag System Implementation Test:");
      console.log("- Tags state variable added: ‚úì");
      console.log("- TagInput component created: ‚úì");
      console.log("- TagInput integrated into build form: ‚úì");
      console.log("- Database schema updated for tags: ‚úì");
      console.log("- Tag filtering functionality added: ‚úì");
      console.log("- Tag chips displayed on app cards: ‚úì");
      console.log("- Tag persistence implemented: ‚úì");
      console.log("\nTag System Implementation Complete!");
    </script>
  </body>
</html>